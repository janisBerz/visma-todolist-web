variables:
  buildConfiguration: 'Release'
  pool: 'windows-latest'
  azureSubscriptionName: 'jb-visual-studio-professional'
  WebAppName: 'my-web-app'
  resourceGroupName: 'my-resource-group'

stages:
- stage: Build
  jobs:
  - job:
    steps:

      - task: DotNetCoreCLI@2
        displayName: 'DotNet Core Restore'
        inputs:
          command: restore
          projects: '**/*.sln'

      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          projects: '**/*.sln'
          arguments: '--configuration $(buildConfiguration) --no-restore'

      - task: DotNetCoreCLI@2
        displayName: 'DotNet Core Package WebApp'
        inputs:
          command: publish
          arguments: '--configuration $(buildConfiguration) --output $(build.artifactstagingdirectory) --no-build'
          projects: '**/*.sln'
          zipAfterPublish: true

      - task: PublishPipelineArtifact@1
        displayName: 'Publish Artifact: WebApp'
        inputs:
          targetPath: '$(build.artifactstagingdirectory)'
          artifactName: 'app'

      - task: PublishPipelineArtifact@1
        displayName: 'Publish Artifact: Infrastructure'
        inputs:
          targetPath: 'templates'
          artifactName: 'templates'

- stage: Deployment_Dev
  jobs:
  - deployment: deployment_dev
    displayName: 'Dev'
    pool:
      vmImage: '$(pool)'
    environment: 'dev'
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            inputs:
              source: 'current'

          - task: AzureResourceGroupDeployment@2
            displayName: 'Provision Web App Dev'
            inputs:
              azureSubscription: '$(azureSubscriptionName)'
              action: 'Create Or Update Resource Group'
              resourceGroupName: '$(resourceGroupName)'
              location: 'West Europe'
              csmFile: 'templates/deploy.json'
              csmParametersFile: 'templates/deploy.parameters.json'
              overrideParameters: -WebAppName $(WebAppName)
              deploymentMode: Incremental

          - task: AzureRmWebAppDeployment@4
            displayName: 'Deploy Web App'
            inputs:
              appType: webApp
              ConnectedServiceName: '$(azureSubscriptionName)'
              WebAppName: '$(WebAppName)'
              package: '$(Pipeline.Workspace)/app/*.zip'
